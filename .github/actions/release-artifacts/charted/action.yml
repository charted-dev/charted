# ðŸ“¦ charted-server: Free, open source, and reliable Helm Chart registry made in Kotlin.
# Copyright 2022-2023 Noelware, LLC. <team@noelware.org>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Artifacts Publishing (charted)
description: Abstraction over publishing artifacts to Noelware's Container Registry
inputs:
  task:
    description: Gradle task to execute
    required: true
  ext:
    description: Extension
    required: true
runs:
  using: composite
  steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Get current release tag
      uses: auguwu/git-tag-action@master
      id: tag

    - name: Setup Java 17
      uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: 17

    # Node.js is required for Spotless to run Prettier
    - name: Setup Node.js 19
      uses: actions/setup-node@v3
      with:
        node-version: 19.x

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2

    - name: Validate Gradle Wrapper
      uses: gradle/wrapper-validation-action@v1

    - name: Lint code-base with Spotless
      uses: gradle/gradle-build-action@v2
      with:
        arguments: spotlessCheck --no-daemon --scan

    - name: Compiles Kotlin source sets
      uses: gradle/gradle-build-action@v2
      with:
        arguments: compileKotlin --no-daemon --scan

    - name: Compiles Java source sets
      uses: gradle/gradle-build-action@v2
      with:
        arguments: compileJava --no-daemon --scan

    - name: Run unit and integration tests
      uses: gradle/gradle-build-action@v2
      with:
        arguments: test --no-daemon --scan

    - name: Build artifact
      uses: gradle/gradle-build-action@v2
      with:
        arguments: :cli:${{inputs.task}} --no-daemon --scan

    - name: Upload artifact to workflow
      uses: actions/upload-artifact@v3
      with:
        name: charted-server.${{inputs.ext}}
        path: ./cli/build/distributions/charted-server.${{inputs.ext}}

    - name: Upload artifact to release
      uses: softprops/action-gh-release@v1
      with:
        files: ./cli/build/distributions/charted-server.${{inputs.ext}}

    - name: Upload artifacts to Noelware's Artifact Registry
      uses: Noelware/s3-action@2.1.0
      with:
        enforce-path-access-style: true
        files: ./cli/build/distributions/charted-server.${{inputs.ext}}
        path-format: $(prefix)/charted/server/${{steps.tag.outputs.version}}/charted-server.${{inputs.ext}}
        access-key-id: ${{secrets.S3_ACCESS_KEY}}
        secret-key: ${{secrets.S3_SECRET_KEY}}
        endpoint: ${{secrets.S3_ENDPOINT}}
        region: us-east-1
        prefix: /noelware/artifacts
        bucket: august
