# üêª‚Äç‚ùÑÔ∏èüì¶ charted-server: Free, open source, and reliable Helm Chart registry made in Kotlin.
# Copyright 2022-2023 Noelware, LLC. <team@noelware.org>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Stable Release Pipeline
on:
    release:
        types: [released]
permissions:
    contents: write
    packages: write
jobs:
    archives:
        name: Build and publish CLI archive [${{matrix.tasks.prettyName}}]
        runs-on: ubuntu-latest
        strategy:
            matrix:
                tasks:
                    - { ext: 'tar.gz', task: 'distTar', prettyName: 'Tarball' }
                    - { ext: 'zip', task: 'distZip', prettyName: 'Zip' }
        steps:
            - uses: ./.github/actions/release-artifacts/charted
              with:
                  task: ${{matrix.tasks.task}}
                  ext: ${{matrix.tasks.ext}}
    migrations:
        name: Build and push ClickHouse migrations
        runs-on: ubuntu-latest
        strategy:
            matrix:
                dist:
                    - { goos: windows, goarch: amd64, ext: '.exe' }
                    - { goos: windows, goarch: i386, ext: '.exe' }
                    - { goos: darwin, goarch: amd64, ext: '' }
                    - { goos: darwin, goarch: arm64, ext: '' }
                    - { goos: linux, goarch: amd64, ext: '' }
                    - { goos: linux, goarch: arm64, ext: '' }
        steps:
            - uses: ./.github/actions/release-artifacts/ch-migrations
              with:
                  goos: ${{matrix.dist.goos}}
                  goarch: ${{matrix.dist.goarch}}
                  ext: ${{matrix.dist.ext}}
    docker-image-debian-x64:
        name: Build Debian Docker Image [linux/amd64]
        runs-on: ubuntu-latest
        steps:
            - uses: ./.github/actions/docker-build-push/stable
              with:
                  dockerfile: ./distribution/docker/debian/Dockerfile
                  platforms: linux/amd64
                  suffix: amd64
    docker-image-alpine-x64:
        name: Build Alpine Docker Image [linux/amd64]
        runs-on: ubuntu-latest
        steps:
            - uses: ./.github/actions/docker-build-push/stable
              with:
                  dockerfile: ./distribution/docker/alpine/Dockerfile
                  platforms: linux/amd64
                  suffix: alpine-amd64
    docker-image-debian-arm:
        name: Build Debian Docker Image [linux/arm64]
        runs-on: self-hosted
        steps:
            - uses: ./.github/actions/docker-build-push/stable
              with:
                  dockerfile: ./distribution/docker/debian/Dockerfile
                  platforms: linux/arm64
                  suffix: arm64
    docker-image-alpine-arm:
        name: Build Alpine Docker Image [linux/arm64]
        runs-on: ubuntu-latest
        steps:
            - uses: ./.github/actions/docker-build-push/stable
              with:
                  dockerfile: ./distribution/docker/alpine/Dockerfile
                  platforms: linux/arm64
                  suffix: alpine-arm64
    manifests:
        name: Merge Docker manifests
        runs-on: ubuntu-latest
        needs: [docker-image-debian-x64, docker-image-alpine-x64, docker-image-debian-arm, docker-image-alpine-arm]
        steps:
            - name: Get current release tag
              uses: auguwu/git-tag-action@master
              id: tag

            - name: Login into GitHub Container Registry
              uses: docker/login-action@v2
              with:
                  registry: ghcr.io
                  username: charted-dev
                  password: ${{secrets.GITHUB_TOKEN}}

            - name: Login into Noelware Container Registry
              uses: docker/login-action@v2
              with:
                  registry: cr.noelware.cloud
                  username: noel
                  password: ${{secrets.REGISTRY_PASSWORD}}

            - name: Create Debian Manifest Image [cr.noelware.cloud, latest]
              uses: Noelware/docker-manifest-action@0.3.1
              with:
                  push: true
                  inputs: cr.noelware.cloud/charted/server:latest
                  images: |
                      cr.noelware.cloud/charted/server:latest-amd64,
                      cr.noelware.cloud/charted/server:latest-arm64

            - name: Create Debian Manifest Image [cr.noelware.cloud, :${{steps.tag.outputs.major}}]
              uses: Noelware/docker-manifest-action@0.3.1
              with:
                  push: true
                  inputs: cr.noelware.cloud/charted/server:${{steps.tag.outputs.major}}
                  images: |
                      cr.noelware.cloud/charted/server:${{steps.tag.outputs.major}}-amd64,
                      cr.noelware.cloud/charted/server:${{steps.tag.outputs.major}}-arm64

            - name: Create Debian Manifest Image [cr.noelware.cloud, :${{steps.tag.outputs.major}}.${{steps.tag.outputs.minor}}]
              uses: Noelware/docker-manifest-action@0.3.1
              with:
                  push: true
                  inputs: cr.noelware.cloud/charted/server:${{steps.tag.outputs.major}}.${{steps.tag.outputs.minor}}
                  images: |
                      cr.noelware.cloud/charted/server:${{steps.tag.outputs.major}}.${{steps.tag.outputs.minor}}-amd64,
                      cr.noelware.cloud/charted/server:${{steps.tag.outputs.major}}.${{steps.tag.outputs.minor}}-arm64

            - name: Create Debian Manifest Image [cr.noelware.cloud, :${{steps.tag.outputs.version}}]
              uses: Noelware/docker-manifest-action@0.3.1
              with:
                  push: true
                  inputs: cr.noelware.cloud/charted/server:${{steps.tag.outputs.version}}
                  images: |
                      cr.noelware.cloud/charted/server:${{steps.tag.outputs.version}}-amd64,
                      cr.noelware.cloud/charted/server:${{steps.tag.outputs.version}}-arm64

            - name: Create Alpine Manifest Image [cr.noelware.cloud, :alpine]
              uses: Noelware/docker-manifest-action@0.3.1
              with:
                  push: true
                  inputs: cr.noelware.cloud/charted/server:alpine
                  images: |
                      cr.noelware.cloud/charted/server:alpine-amd64,
                      cr.noelware.cloud/charted/server:alpine-arm64

            - name: Create Alpine Manifest Image [cr.noelware.cloud, :${{steps.tag.outputs.major}}-alpine]
              uses: Noelware/docker-manifest-action@0.3.1
              with:
                  push: true
                  inputs: cr.noelware.cloud/charted/server:${{steps.tag.outputs.major}}-alpine
                  images: |
                      cr.noelware.cloud/charted/server:${{steps.tag.outputs.major}}-alpine-amd64,
                      cr.noelware.cloud/charted/server:${{steps.tag.outputs.major}}-alpine-arm64

            - name: Create Alpine Manifest Image [cr.noelware.cloud, :${{steps.tag.outputs.major}}.${{steps.tag.outputs.minor}}-alpine]
              uses: Noelware/docker-manifest-action@0.3.1
              with:
                  push: true
                  inputs: cr.noelware.cloud/charted/server:${{steps.tag.outputs.major}}.${{steps.tag.outputs.minor}}-alpine
                  images: |
                      cr.noelware.cloud/charted/server:${{steps.tag.outputs.major}}.${{steps.tag.outputs.minor}}-alpine-amd64,
                      cr.noelware.cloud/charted/server:${{steps.tag.outputs.major}}.${{steps.tag.outputs.minor}}-alpine-arm64

            - name: Create Alpine Manifest Image [cr.noelware.cloud, :${{steps.tag.outputs.version}}-alpine]
              uses: Noelware/docker-manifest-action@0.3.1
              with:
                  push: true
                  inputs: cr.noelware.cloud/charted/server:${{steps.tag.outputs.version}}-alpine
                  images: |
                      cr.noelware.cloud/charted/server:${{steps.tag.outputs.version}}-alpine-amd64,
                      cr.noelware.cloud/charted/server:${{steps.tag.outputs.version}}-alpine-arm64

            - name: Create Debian Manifest Image [ghcr.io, latest]
              uses: Noelware/docker-manifest-action@0.3.1
              with:
                  push: true
                  inputs: ghcr.io/charted-dev/charted:latest
                  images: |
                      ghcr.io/charted-dev/charted:latest-amd64,
                      ghcr.io/charted-dev/charted:latest-arm64

            - name: Create Debian Manifest Image [ghcr.io, :${{steps.tag.outputs.major}}]
              uses: Noelware/docker-manifest-action@0.3.1
              with:
                  push: true
                  inputs: ghcr.io/charted-dev/charted:${{steps.tag.outputs.major}}
                  images: |
                      ghcr.io/charted-dev/charted:${{steps.tag.outputs.major}}-amd64,
                      ghcr.io/charted-dev/charted:${{steps.tag.outputs.major}}-arm64

            - name: Create Debian Manifest Image [ghcr.io, :${{steps.tag.outputs.major}}.${{steps.tag.outputs.minor}}]
              uses: Noelware/docker-manifest-action@0.3.1
              with:
                  push: true
                  inputs: ghcr.io/charted-dev/charted:${{steps.tag.outputs.major}}.${{steps.tag.outputs.minor}}
                  images: |
                      ghcr.io/charted-dev/charted:${{steps.tag.outputs.major}}.${{steps.tag.outputs.minor}}-amd64,
                      ghcr.io/charted-dev/charted:${{steps.tag.outputs.major}}.${{steps.tag.outputs.minor}}-arm64

            - name: Create Debian Manifest Image [ghcr.io, :${{steps.tag.outputs.version}}]
              uses: Noelware/docker-manifest-action@0.3.1
              with:
                  push: true
                  inputs: ghcr.io/charted-dev/charted:${{steps.tag.outputs.version}}
                  images: |
                      ghcr.io/charted-dev/charted:${{steps.tag.outputs.version}}-amd64,
                      ghcr.io/charted-dev/charted:${{steps.tag.outputs.version}}-arm64

            - name: Create Alpine Manifest Image [ghcr.io, :alpine]
              uses: Noelware/docker-manifest-action@0.3.1
              with:
                  push: true
                  inputs: ghcr.io/charted-dev/charted:alpine
                  images: |
                      ghcr.io/charted-dev/charted:alpine-amd64,
                      ghcr.io/charted-dev/charted:alpine-arm64

            - name: Create Alpine Manifest Image [ghcr.io, :${{steps.tag.outputs.major}}-alpine]
              uses: Noelware/docker-manifest-action@0.3.1
              with:
                  push: true
                  inputs: ghcr.io/charted-dev/charted:${{steps.tag.outputs.major}}-alpine
                  images: |
                      ghcr.io/charted-dev/charted:${{steps.tag.outputs.major}}-alpine-amd64,
                      ghcr.io/charted-dev/charted:${{steps.tag.outputs.major}}-alpine-arm64

            - name: Create Alpine Manifest Image [ghcr.io, :${{steps.tag.outputs.major}}.${{steps.tag.outputs.minor}}-alpine]
              uses: Noelware/docker-manifest-action@0.3.1
              with:
                  push: true
                  inputs: ghcr.io/charted-dev/charted:${{steps.tag.outputs.major}}.${{steps.tag.outputs.minor}}-alpine
                  images: |
                      ghcr.io/charted-dev/charted:${{steps.tag.outputs.major}}.${{steps.tag.outputs.minor}}-alpine-amd64,
                      ghcr.io/charted-dev/charted:${{steps.tag.outputs.major}}.${{steps.tag.outputs.minor}}-alpine-arm64

            - name: Create Alpine Manifest Image [ghcr.io, :${{steps.tag.outputs.version}}-alpine]
              uses: Noelware/docker-manifest-action@0.3.1
              with:
                  push: true
                  inputs: ghcr.io/charted-dev/charted:${{steps.tag.outputs.version}}-alpine
                  images: |
                      ghcr.io/charted-dev/charted:${{steps.tag.outputs.version}}-alpine-amd64,
                      ghcr.io/charted-dev/charted:${{steps.tag.outputs.version}}-alpine-arm64
